# [SB20] HÆ°á»›ng dáº«n toÃ n táº­p Mockito

### **YÃªu cáº§u**

TrÆ°á»›c khi tÃ¬m hiá»ƒu Mockito, báº¡n cáº§n biáº¿t JUnit.

Trong bÃ i viáº¿t cÃ³ sá»­ dá»¥ngÂ Lombok

### **Giá»›i thiá»‡u**

Vá» cÆ¡ báº£n, Unit test lÃ  phÆ°Æ¡ng phÃ¡p tiáº¿p cáº­n Ä‘á»™c láº­p, tá»©c lÃ  má»—i má»™t chá»©c chÄƒng nÄƒng sáº½ Ä‘Æ°á»£c Ä‘i kÃ¨m vá»›i má»™t hoáº·c nhiá»u bÃ i test Ä‘á»ƒ cháº¯c cháº¯n rÃ ng cÃ¡i chá»©c nÄƒng Ä‘Ã³ hoáº¡t Ä‘á»™ng á»•n. Váº­y nÃªn Unit Test thÆ°á»ng lÃ  Ä‘Æ¡n nhá» nháº¥t vÃ  test case cÅ©ng dá»… dÃ ng khá»Ÿi táº¡o

```
@Test
public void testSum(){
    Assert.assertEquals(3, MathUtil.sum(1,2));
}
```

BÃ i toÃ¡n má»Ÿ rá»™ng ra hÆ¡n, Khi chÃºng ta pháº£i test sá»± hoáº¡t Ä‘á»™ng phá»‘i há»£p giá»¯a nhiá»u chá»©c nÄƒng hay thÃ nh pháº§n vá»›i nhau hoáº·c muá»‘n test má»™t chá»©c nÄƒng lá»›n thÃ¬ sáº½ trá»Ÿ nÃªn phá»©c táº¡p vÃ  khÃ³ xÃ¢y dá»±ng hÆ¡n ráº¥t nhiá»u.

CÃ¡c ká»‹ch báº£n sau thÆ°á»ng diá»…n ra:

- Chá»©c nÄƒng A gá»i tá»›i chá»©c nÄƒng B. tuy nhiÃªn, B chÆ°a viáº¿t xong
- Chá»©c nÄƒng A gá»i tá»›i chá»©c nÄƒng B. tuy nhiÃªn, B khá»Ÿi táº¡o ráº¥t phá»©c táº¡p (truy xuáº¥t Database, yÃªu cáº§u nhiá»u params, v.v.)
- Muá»‘n test chá»©c nÄƒng A, tuy nhiÃªn A yÃªu cáº§u ná»— lá»±c lá»›n cá»§a cáº£ há»‡ thá»‘ng (YÃªu cáº§u cÃ³ HTTP-server, authorize, v.v.)

```
// Giáº£ sá»­ muá»‘n test hÃ m nÃ y
public int getAllData(){

    // Giáº£ sá»­ nhÆ° tháº±ng driver khÃ´ng Ä‘Æ°á»£c khá»Ÿi táº¡o hoáº·c bá»‹ lá»—i
    // thÃ¬ function nÃ y coi nhÆ° há»ng

    MySQLdriver.connect() // Káº¿t ná»‘i xuá»‘ng Database
    var data = MySQLdriver.get()// Láº¥y dá»¯ liá»‡u

    // ChÃºng ta muá»‘n test logic xá»­ lÃ½ dá»¯ liá»‡u á»Ÿ dÆ°á»›i Ä‘Ã¢y,
    // mÃ  k cáº§n káº¿t ná»‘i databse, pháº£i lÃ m sao?

    // Xá»­ lÃ½ dá»¯ liá»‡u
    ...
    // tráº£ ra dá»¯ liá»‡u
    return data
}
```

Ráº¥t nhiá»u ká»‹ch báº£n phá»©c táº¡p xáº£y ra, mÃ  trÃªn thá»±c táº¿, chÃºng ta chá»‰ mong muá»‘n confirm ráº±ng A á»•n, chá»© tháº±ng B, C, D gÃ¬ Ä‘Ã³ thÃ¬ hÃ£y cá»© táº¡m coi lÃ  nÃ³ "Ä‘Ã£ á»•n" Ä‘i.

Äá»ƒ Ä‘Æ¡n giáº£n hoÃ¡ cÃ¡c ká»‹ch báº£n test nhÆ° trÃªn, khÃ¡i niá»‡mÂ `Mock`Â ra Ä‘á»i.

TÆ° tÆ°á»Ÿng cá»§aÂ `Mock`Â Ä‘Æ¡n giáº£n lÃ  khi muá»‘n test (A gá»i B) thÃ¬ thay vÃ¬ táº¡o ra má»™t Ä‘á»‘i tÆ°á»£ng B tháº­t sá»±, báº¡n táº¡o ra má»™t tháº±ng B' giáº£ máº¡o, cÃ³ Ä‘áº§y Ä‘á»§ chá»©c nÄƒng nhÆ° B tháº­t (nhÆ°ng khÃ´ng pháº£i tháº­t)

Báº¡n sáº½ giáº£ láº­p cho B' biáº¿t lÃ  khi tháº±ng A gá»i tá»›i nÃ³, nÃ³ cáº§n lÃ m gÃ¬, tráº£ láº¡i cÃ¡i gÃ¬ (hardcode). Miá»…n lÃ m sao cho nÃ³ tráº£ ra Ä‘Ãºng cÃ¡i tháº±ng A cáº§n Ä‘á»ƒ chÃºng ta cÃ³ thá»ƒ test A thuáº­n lá»£i nháº¥t.

```
// Äáº¡i loáº¡i nhÆ° nÃ y
// Khi driver.get() Ä‘Æ°á»£c gá»i, hÃ£y tráº£ ra má»™t List(1,2,3)
Mockito.when(driver.get())
       .thenReturn(Arrays.asList(1, 2, 3));
```

á» trong Java,Â `Mockito`Â chÃ­nh lÃ  thÆ° viá»‡n ná»•i tiáº¿ng nháº¥t Ä‘á»ƒ cÃ¡c báº¡n lÃ m viá»‡c nÃ y.

### **CÃ i Ä‘áº·t**

Äá»ƒ sá»­ dá»¥ngÂ `Mockito`Â báº¡n cáº§n:

```
<!--https://mvnrepository.com/artifact/org.mockito/mockito-core -->
<dependency><groupId>org.mockito</groupId><artifactId>mockito-core</artifactId><version>3.2.4</version><scope>test</scope></dependency>
```

ChÃºng ta Ä‘ang viáº¿t test, nÃªn Ä‘á»«ng quÃªnÂ `JUnit`Â ná»¯a nhÃ©:

```
<!--https://mvnrepository.com/artifact/junit/junit -->
<dependency><groupId>junit</groupId><artifactId>junit</artifactId><version>4.12</version><scope>test</scope></dependency>
```

### **CÃ¡ch Mock**

KhÃ¡i niá»‡m cÆ¡ báº£n Ä‘áº§u tiÃªn, Ä‘Ã³ lÃ  lÃ m sao Ä‘á»ƒ táº¡o ra má»™t Ä‘á»‘i tÆ°á»£ng bá»‹ Mock.

### **CÃ¡ch 1: Mockito.mock()**

Sá»­ dá»¥ngÂ `Mockito.mock()`Â Ä‘á»ƒ táº¡o ra má»™t object cá»§aÂ `Class`Â báº¡n yÃªu cáº§u, nÃ³ tháº­m chÃ­ cÃ²n khÃ´ng quan tÃ¢m hÃ m khá»Ÿi táº¡o cá»§aÂ `Class`Â Ã½ nhÆ° nÃ o vÃ  ra sao, vÃ¬ nÃ³ Ä‘Ã¢u cÃ³ tháº­t :v

```
@Test
public void testUserMockFunction() {
    List mockList = Mockito.mock(List.class);

    Mockito.when(mockList.size()).thenReturn(2);

    Assert.assertEquals(2, mockList.size());
}
```

### **CÃ¡ch 2: Sá»­ dá»¥ng @Mock**

Báº¡n muá»‘n mock cÃ¡i gÃ¬, thÃ¬ Ä‘Ã¡nh dáº¥uÂ `@Mock`Â lÃªn Ã½, Ä‘Æ¡n giáº£n vÃ£i :v

```
@Mock
List<String> mockedList;
```

Tuy nhiÃªn, gáº¯nÂ `@Mock`Â lÃ  chÆ°a Ä‘á»§, báº¡n cáº§n kÃ­ch hoáº¡tÂ `Mockito`Â Ä‘á»ƒ nÃ³ mock cÃ¡c object Ã½ cho báº¡n.

Sau khi kÃ­ch hoáº¡t, thÃ¬ táº¥t cáº£ cÃ¡c object Ä‘Æ°á»£c gáº¯nÂ `@Mock`Â sáº½ trá»Ÿ thÃ nh 1 object giáº£ máº¡o, vÃ  Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o (tá»©c lÃ Â `!= null`)

CÃ¡c cÃ¡ch kÃ­ch hoáº¡t nhÆ° sau:

1. Gáº¯nÂ `@RunWith(MockitoJUnitRunner.class)`Â lÃªn class test cá»§a báº¡n

```
// CÃ¡ch 1
@RunWith(MockitoJUnitRunner.class)
public class MockitoAnnotationTest {
    @Mock
    List<String> mockedList;
}
```

1. táº¡o ra má»™t Ä‘á»‘i tÆ°á»£ngÂ `MockitoRule`Â bÃªn trong class test cá»§a báº¡n

```
public class MockitoAnnotationTest {

    // CÃ¡ch 2
    @Rule
    public MockitoRule initRule = MockitoJUnit.rule();

    @Mock
    List<String> mockedList;
}
```

1. Sá»­ dá»¥ngÂ `Mockito.init()`

```
public class MockitoAnnotationTest {

    @Mock
    List<String> mockedList;

    @Before
    public void setUp() throws Exception {
        // CÃ¡ch 3
        // Náº¿u báº¡n khÃ´ng dÃ¹ng cÃ¡ch 1 hoáº·c 2 thÃ¬ pháº£i sá»­ dá»¥ng
        // dÃ²ng code dÆ°á»›i Ä‘Ã¢y:
        MockitoAnnotations.initMocks(this);
    }
}
```

Váº­y lÃ  xong, báº¡n Ä‘Ã£ táº¡o ra Ä‘Æ°á»£c má»™t Object bá»‹ mock.

### **CÃ¡ch sá»­ dá»¥ng**

`Mockito`Â cung cáº¥p ráº¥t nhiá»u methods khÃ¡c nhau Ä‘á»ƒ giÃºp báº¡n giáº£ láº­p Ä‘áº§y Ä‘á»§ cÃ¡c thá»© báº¡n cáº§n.

Hay sá»­ dá»¥ng nháº¥t lÃ  hÃ mÂ `when()`.

```
// Tráº£ lÃ  size 100 khi gá»i hÃ m size()
Mockito.when(mockedList.size()).thenReturn(100);
// Throw exception khi gá»i hÃ m size()
Mockito.when(mockedList.size()).thenThrow(NullPointerException.class);
// Báº¡n cÃ³ thá»ƒ Ä‘á»•i ngÆ°á»£c cÃ¡ch viáº¿t, cÃ²n logic váº«n váº­y
// NÃ©m ra exception khi gá»i hÃ m .get() vá»›i tham sá»‘ truyá»n vÃ o báº¥t kÃ¬
Mockito.doThrow(NullPointerException.class).when(mockedList.get(Mockito.any()));
```

### **Spy**

`Spy`Â lÃ  viá»‡c sá»­a má»™t Ä‘á»‘i tÆ°á»£ng Tháº­t -> Giáº£

```
@RunWith(MockitoJUnitRunner.class)
public class SpyTest {
    @Spy
    List<String> list = new ArrayList<>();

    @Test
    public void testSpy() {
        list.add("one");
        list.add("two");
        // show the list items
        System.out.println(list);

        Mockito.verify(list).add("one");
        Mockito.verify(list).add("two");

        // @Spy thá»±c sá»± gá»i hÃ m .add cá»§a List nÃªn nÃ³ cÃ³ size lÃ  2 mÃ  khÃ´ng cáº§n giáº£ láº­p
        Assert.assertEquals(2, list.size());

        // Váº«n cÃ³ thá»ƒ lÃ m giáº£ thÃ´ng tin gá»i hÃ m vá»›i @Spy
        Mockito.when(list.size()).thenReturn(100);

        Assert.assertEquals(100, list.size());
    }
}
```

### **Captor**

`Captor`Â cÃ³ nhiá»‡m vá»¥ ghi láº¡i cÃ¡c tham sá»‘ cá»§a Ä‘á»‘i tÆ°á»£ng

```
@RunWith(MockitoJUnitRunner.class)
public class CaptorTest {
    @Mock
    List<Object> list;

    @Captor
    ArgumentCaptor<Object> captor;

    @Test
    public void testCaptor1() {
        list.add(1);
        // Capture láº§n gá»i add vá»«a rá»“i cÃ³ giÃ¡ trá»‹ lÃ  gÃ¬
        Mockito.verify(list).add(captor.capture());

        System.out.println(captor.getAllValues());

        Assert.assertEquals(1, captor.getValue());
    }
}
```

### **Inject Mock**

Quay láº¡i vá»›i vÃ­ dá»¥ Ä‘áº§u bÃ i viáº¿t:

TÃ´i cÃ³ má»™t lá»›pÂ `Service`Â chá»©a lá»›pÂ `DatabaseDriver`Â nhÆ° sau:

```
public interface DatabaseDriver {
    List<Object> get() throws SQLException;
}

@Data
@AllArgsConstructor
public static class SuperService {
    DatabaseDriver driver;

    public List<Object> getObjects() throws SQLException {
        System.out.println("LOG: Getting objects");
        List<Object> list = driver.get();

        System.out.println("LOG: Sorting");
        Collections.sort(list, Comparator.comparingInt(value -> Integer.valueOf(value.toString())));

        System.out.println("LOG: Done");
        return list;
    }
}
```

RÃµ rÃ ng thÃ¬Â `driver`Â chÃ­nh lÃ  máº¯t xÃ­ch trong trong viá»‡cÂ `SuperService`Â cÃ³ hoáº¡t Ä‘á»™ng Ä‘Æ°á»£c hay khÃ´ng. VÃ¬ tháº¿, muá»‘n test Ä‘Æ°á»£cÂ `SuperService`, chÃºng ta pháº£i mock Ä‘á»‘i tÆ°á»£ngÂ `driver`.

ká»‹ch báº£n bÃ¢y giá» sáº½ lÃ  tÃ´i mock má»™t Ä‘á»‘i tÆ°á»£ng cá»§aÂ `DatabaseDriver`Â rá»“i truyá»n nÃ³ vÃ o Ä‘á»‘i tÆ°á»£ngÂ `SuperService`.

Äá»ƒ truyá»n má»™t Ä‘á»‘i tÆ°á»£ng mock vÃ o má»™t Ä‘á»‘i tÆ°á»£ng khÃ¡c, chÃºng ta dÃ¹ngÂ `@InjectMocks`.

```
@RunWith(MockitoJUnitRunner.class)
public class InjectMockTest {
    @Mock
    DatabaseDriver driver;

    /**
     * Inject driver vÃ o superService.
     * Má»i ngÆ°á»i cÃ³ thá»ƒ liÃªn tÆ°á»Ÿng nÃ³ giá»‘ng vá»›i Spring Injection
     */
    @InjectMocks
    SuperService superService;

    @Test(expected = SQLException.class)
    public void testInjectMock() throws SQLException {
        // Giáº£ láº­p cho driver luÃ´n tráº£ vá» list (3,2,1) khi Ä‘Æ°á»£c gá»i tá»›i
        Mockito.doReturn(Arrays.asList(3, 2, 1)).when(driver).get();

        Assert.assertEquals(driver, superService.getDriver());

        // Test xem superService tráº£ ra ngoÃ i cÃ³ Ä‘Ãºng khÃ´ng?
        Assert.assertEquals(Arrays.asList(1, 2, 3), superService.getObjects());

        // Giáº£ láº­p cho driver báº¯n exception
        Mockito.when(driver.get()).thenThrow(SQLException.class);
        superService.getObjects();
    }
}
```

### **Káº¿t**

Tá»›i Ä‘Ã¢y, báº¡n Ä‘Ã£ cÃ³ thá»ƒ dÃ¹ngÂ `Mockito`Â xoÃ nh xoáº¡ch rá»“i.

Tiáº¿p theo, cÃ³ thá»ƒ Ä‘á»c cÃ¡ch sá»­ dá»¥ngÂ `Mockito`Â vá»›iÂ `Spring Boot`táº¡i Ä‘Ã¢y

ğŸ’Â Náº¿u cÃ³, toÃ n bá»™ project / code máº«u Ä‘Æ°á»£c lÆ°u trá»¯ táº¡i **GitHub**

ğŸŒŸÂ ÄÃ¢y lÃ  má»™t bÃ i viáº¿t trongÂ Series **LÃ m chá»§ Spring Boot â€“ Zero to Hero**

