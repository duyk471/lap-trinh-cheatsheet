[SB23] Xá»­ lÃ½ sá»± kiá»‡n vá»›i @EventListener + @Async
=========================================================

- Giá»›i thiá»‡u
- CÆ¡ báº£n vá» Event & Listener
- Ãp vÃ o thá»±c táº¿
- Event
- Event Publisher
- Event Listener
- Cháº¡y thá»­ 1
- @Async
- @Async
- Cháº¡y thá»­ láº§n 2
- Káº¿t

### **Giá»›i thiá»‡u**

Háº³n trongÂ **Java**Â khÃ´ng Ã­t thÃ¬ nhiá»u cÃ¡c báº¡n Ä‘Ã£ tá»«ng sá»­ dá»¥ng quaÂ `Listener Pattern`Â rá»“i, nÃªn tÃ´i nghÄ© sáº½ khÃ´ng giá»›i thiá»‡u vá» nÃ³ ná»¯a.

Trong bÃ i viáº¿t nÃ y, chÃºng ta táº­p trung vÃ o cÃ¡ch lÃ m sao Ä‘á»ƒ thá»±c hiá»‡n viá»‡c táº¡o raÂ `Event`Â vÃ  xá»­ lÃ½Â `Event`Â Ä‘Ã³ má»™t cÃ¡ch gá»n gÃ ng vá»›iÂ **Spring Boot**.

BÃ i nÃ y yÃªu cáº§u kiáº¿n thá»©c cÆ¡ báº£n:

1. ã€ŒSpring Boot #0ã€ Series lÃ m chá»§ Spring Boot, Zero to Hero

### **CÆ¡ báº£n vá» Event & Listener**

!image

CÆ¡ báº£n lÃ  khi chÆ°Æ¡ng trÃ¬nh cá»§a báº¡n Ä‘ang váº­n hÃ nh, vÃ  cÃ³ má»™t cÃ´ng viá»‡c gÃ¬ Ä‘Ã³, báº¡n khÃ´ng muá»‘n xá»­ lÃ½ trá»±c tiáº¿p táº¡i Class hiá»‡n hÃ nh hoáº·c muá»‘n thÃ´ng bÃ¡o cho cÃ¡c Äá»‘i tÆ°á»£ng khÃ¡c biáº¿t báº¡n vá»«a lÃ m gÃ¬.

ThÃ¬ báº¡n sáº½ báº¯n ra má»™t object gá»i lÃ Â `Event`Â (sá»± kiá»‡n), cÃ³ hoáº·c khÃ´ng thÃ´ng tin Ä‘i kÃ¨m, vÃ  nhiá»‡m vá»¥ cá»§a cÃ¡c tháº±ng khÃ¡c lÃ  Ä‘Ã³n láº¥y hay láº¯ng nghe sá»± kiá»‡n Ä‘Ã³ Ä‘á»ƒ xá»­ lÃ½ nghiá»‡p vá»¥ cá»§a riÃªng nÃ³, tháº±ng xá»­ lÃ½ gá»i lÃ Â `Listener`.

Tháº±ng gÃ¢y ra sá»± kiá»‡n gá»i lÃ Â `Source`.

CÃ²n tháº±ng cáº§m sá»± kiá»‡n Ä‘Ã³ nÃ©m choÂ `Listener`Â gá»i lÃ Â `Pushlisher`

### **Ãp vÃ o thá»±c táº¿**

Giáº£ sá»­ báº¡n cÃ³ má»™t cÃ¡i chuÃ´ng cá»­a, khi cÃ³ ngÆ°á»i tá»›i báº¥m cÃ¡i chuÃ´ng nÃ y. ChuÃ´ng sáº½ phÃ¡t ra tiáº¿ng kÃªu.

á» trong nhÃ  cÃ³ chÃ³, nÃ³ nghe tháº¥y tiáº¿ng kÃªu, nÃ³ sáº½ sá»§a lÃªn.

ThÃ¬:

- `Source`: NgÆ°á»i báº¥m chuÃ´ng cá»­a, lÃ  ngÆ°á»i gÃ¢y ra sá»± kiá»‡n.
- `Event`: sá»± kiá»‡n báº¥m chuÃ´ng cá»­a
- `Pushlisher`: CÃ¡i chuÃ´ng phÃ¡t ra Ã¢m thanh (sá»± kiá»‡n) Ä‘á»ƒ thÃ´ng bÃ¡o.
- `Listener`: Con chÃ³ láº¯ng nghe vÃ  xá»­ lÃ½ sá»± kiá»‡n

### **Event**

Má»™tÂ `Event`Â (sá»± kiá»‡n) muá»‘n Ä‘Æ°á»£cÂ **Spring Boot**Â há»— trá»£ thÃ¬ sáº½ pháº£i káº¿ thá»«a lá»›pÂ `ApplicationEvent`.

```
/*
DoorBellEvent pháº£i káº¿ thá»«a lá»›p ApplicationEvent cá»§a Spring
NhÆ° váº­y nÃ³ má»›i Ä‘Æ°á»£c coi lÃ  má»™t sá»± kiá»‡n há»£p lá»‡.
 */
public class DoorBellEvent extends ApplicationEvent {
    /*
        Má»i Class káº¿ thá»«a ApplicationEvent sáº½
        pháº£i gá»i Constructor tá»›i lá»›p cha.
     */
    public DoorBellEvent(Object source, String guestName) {
        // Object source lÃ  object tham chiáº¿u tá»›i
        // nÆ¡i Ä‘Ã£ phÃ¡t ra event nÃ y!
        super(source);
    }
}
```

### **Event Publisher**

TrongÂ **Spring Boot**, Ä‘á»ƒ báº¯n ra má»™t sá»± kiá»‡n chÃºng ta sá»­ dá»¥ng Ä‘á»‘i tÆ°á»£ngÂ `ApplicationEventPublisher`. ÄÃ¢y lÃ  má»™tÂ `Bean`Â cÃ³ sáºµn trongÂ `Context`Â do Spring cung cáº¥p, báº¡n chá»‰ cáº§n lÃ´i ra sá»­ dá»¥ng thÃ´i.

```
@Component
public class MyHouse {
    @Autowired
    ApplicationEventPublisher applicationEventPublisher;

    /**
     * HÃ nh Ä‘á»™ng báº¥m chuÃ´ng cá»­a
     */
    public void rangDoorbellBy(String guestName) {
        // PhÃ¡t ra má»™t sá»± kiá»‡n DoorBellEvent
        // source (Nguá»“n phÃ¡t ra) chÃ­nh lÃ  class nÃ y
        applicationEventPublisher.publishEvent(new DoorBellEvent(this, guestName));
    }
}
```

### **Event Listener**

Äá»ƒ láº¯ng nghe cÃ¡c sá»± kiá»‡n doÂ `ApplicationEventPublisher`Â báº¯n ra, chÃºng ta sá»­ dá»¥ngÂ `@EventListener`

```
// Táº¡o ra Bean
@Component
public class MyDog {

    /*
        @EventListener sáº½ láº¯ng nghe má»i sá»± kiá»‡n xáº£y ra
        Náº¿u cÃ³ má»™t sá»± kiá»‡n DoorBellEvent Ä‘Æ°á»£c báº¯n ra, nÃ³ sáº½ Ä‘Ã³n láº¥y
        vÃ  Ä‘Æ°a vÃ o hÃ m Ä‘á»ƒ xá»­ lÃ½
     */
    @EventListener
    public void doorBellEventListener(DoorBellEvent doorBellEvent) throws InterruptedException {
        // Giáº£ sá»­ con chÃ³ Ä‘ang ngá»§, 1 giÃ¢y sau má»›i dáº­y
        Thread.sleep(1000);
        // Sá»± kiá»‡n DoorBellEvent Ä‘Æ°á»£c láº¯ng nghe vÃ  xá»­ lÃ½ táº¡i Ä‘Ã¢y
        System.out.println(Thread.currentThread().getName() + ": ChÃ³ ngá»§ dáº­y!!!");
        System.out.println(String.format("%s: Go go!! CÃ³ ngÆ°á»i tÃªn lÃ  %s gÃµ cá»­a!!!", Thread.currentThread().getName(), doorBellEvent.getGuestName()));
    }
}
```

`@EventListener`Â gáº¯n trÃªn má»™t method, vá»›i tham sá»‘ Ä‘áº§u vÃ o chÃ­nh lÃ  sá»± kiá»‡n mÃ  báº¡n muá»‘n láº¯ng nghe.

LÆ°u Ã½: Class chá»‹u trÃ¡ch nhiá»‡m xá»­ lÃ½, cÃ³ chá»©a methodÂ `@EventListener`Â cÅ©ng pháº£i lÃ  Bean nhÃ©.

### **Cháº¡y thá»­ 1**

```
@SpringBootApplication
public class App {
    @Autowired
    MyHouse myHouse;

    public static void main(String[] args) {
        SpringApplication.run(App.class, args);
    }

    @Bean
    CommandLineRunner run() {
        return args -> {
            System.out.println(Thread.currentThread().getName() + ": Loda Ä‘i tá»›i cá»­a nhÃ  !!!");
            System.out.println(Thread.currentThread().getName() + ": => Loda báº¥m chuÃ´ng vÃ  khai bÃ¡o há» tÃªn!");
            // gÃµ cá»­a
            myHouse.rangDoorbellBy("Loda");
            System.out.println(Thread.currentThread().getName() +": Loda quay lÆ°ng bá» Ä‘i");
        };
    }

}
```

OUTPUT:

```
restartedMain: Loda Ä‘i tá»›i cá»­a nhÃ  !!!
restartedMain: => Loda báº¥m chuÃ´ng vÃ  khai bÃ¡o há» tÃªn!
restartedMain: ChÃ³ ngá»§ dáº­y!!!
restartedMain: Go go!! CÃ³ ngÆ°á»i tÃªn lÃ  Loda gÃµ cá»­a!!!
restartedMain: Loda quay lÆ°ng bá» Ä‘i
```

Báº¡n sáº½ tháº¥y quÃ¡ trÃ¬nh xá»­ lÃ½ á»Ÿ Ä‘Ã¢y xáº£y ra má»™t cÃ¡chÂ **tuáº§n tá»±**Â vÃ  Ä‘á»“ng bá»™ (Synchronous).

Váº­y lÃ  chÃºng ta cÃ³ thá»ƒ hiá»ƒu:

> náº¿u khÃ´ng cáº¥u hÃ¬nh gÃ¬ thÃªm,Â ApplicationEventÂ vÃ Â @EventListenerÂ lÃ Â Synchronous.

ChÆ°Æ¡ng trÃ¬nh sáº½ pháº£i chá» sá»± kiá»‡n xá»­ lÃ½ xong thÃ¬ má»›i Ä‘Æ°á»£c cháº¡y tiáº¿p.

### **@Async**

Äa pháº§n, xá»­ lÃ½ Synchronous khÃ´ng pháº£i Ä‘iá»u mÃ  chÃºng ta mong Ä‘á»£i, chÃºng ta muá»‘n viá»‡c xá»­ lÃ½ sá»± kiá»‡n cÃ³ thá»ƒ hoáº¡t Ä‘á»™ng riÃªng vÃ  khÃ´ng áº£nh hÆ°á»Ÿng tá»›i luá»“ng lÃ m viá»‡c chÃ­nh.

NÃ³i cÃ¡ch khÃ¡c, chÃºng ta muá»‘n sá»± kiá»‡n Ä‘Æ°á»£c xá»­ lÃ½ á»Ÿ má»™t Thread khÃ¡c, Ä‘Ã¢y gá»i lÃ Â **báº¥t Ä‘á»“ng bá»™ (Asynchronous)**

Äá»ƒ lÃ m Ä‘Æ°á»£c Ä‘iá»u nÃ y, chÃºng ta cáº§n kÃ­ch hoáº¡t chá»©c nÄƒng xá»­ lÃ½ báº¥t Ä‘á»“ng bá»™ cá»§aÂ **Spring Boot**, báº±ng cÃ¡ch bá»• sung annotationÂ `@EnableAsync`.

```
@Configuration
@EnableAsync
public class ListenerConfiguration {
    /**
     * Táº¡o ra Executor cho Async
     * @return
     */
    @Bean
    TaskExecutor taskExecutor() {
        return new SimpleAsyncTaskExecutor();
    }
}
```

**Spring Boot**Â khi tháº¥y Annotation nÃ y, sáº½ kÃ­ch hoáº¡t cho phÃ©p xá»­ lÃ½ sá»± kiá»‡n dÆ°á»›i dáº¡ng Async

cÃ¡cÂ `Event`Â sáº½ Ä‘Æ°á»£c gá»­i vÃ o má»™tÂ `Executor`Â (Ä‘Æ¡n giáº£n nháº¥t lÃ Â `SimpleAsyncTaskExecutor`) vÃ  chá» Ä‘Æ°á»£c xá»­ lÃ½.

Náº¿u chÆ°a biáº¿tÂ `Executor`Â lÃ  gÃ¬, báº¡n cÃ³ thá»ƒ Ä‘á»c 2 bÃ i viáº¿t sau:

1. KhÃ¡i niá»‡m ThreadPool vÃ  Executor trong Java
2. ThreadPoolExecutor vÃ  nguyÃªn táº¯c quáº£n lÃ½ pool size

### **@Async**

Sau khi kÃ­ch hoáº¡t tÃ­nh nÄƒngÂ `Async`, báº¥t ká»³ sá»± kiá»‡n nÃ o báº¡n muá»‘n nÃ³ xá»­ lÃ½ Async thÃ¬ hÃ£y Ä‘Ã¡nh dáº¥u nÃ³ bá»ŸiÂ `@Async`.

```
@Component
public class MyDog {

    /*
        @EventListener sáº½ láº¯ng nghe má»i sá»± kiá»‡n xáº£y ra
        Náº¿u cÃ³ má»™t sá»± kiá»‡n DoorBellEvent Ä‘Æ°á»£c báº¯n ra, nÃ³ sáº½ Ä‘Ã³n láº¥y
        vÃ  Ä‘Æ°a vÃ o hÃ m Ä‘á»ƒ xá»­ lÃ½
     */
    /*
        @Async lÃ  cÃ¡ch láº¯ng nghe sá»± kiá»‡n á»Ÿ má»™t Thread khÃ¡c, khÃ´ng áº£nh hÆ°á»Ÿng tá»›i
        luá»“ng chÃ­nh
     */
    @Async
    @EventListener
    public void doorBellEventListener(DoorBellEvent doorBellEvent) throws InterruptedException {
        // Giáº£ sá»­ con chÃ³ Ä‘ang ngá»§, 1 giÃ¢y sau má»›i dáº­y
        Thread.sleep(1000);
        // Sá»± kiá»‡n DoorBellEvent Ä‘Æ°á»£c láº¯ng nghe vÃ  xá»­ lÃ½ táº¡i Ä‘Ã¢y
        System.out.println("ChÃ³ ngá»§ dáº­y!!!");
        System.out.println(String.format("Go go!! CÃ³ ngÆ°á»i tÃªn lÃ  %s gÃµ cá»­a!!!", doorBellEvent.getGuestName()));
    }
}
```

### **Cháº¡y thá»­ láº§n 2**

OUTPUT:

```
restartedMain: Loda Ä‘i tá»›i cá»­a nhÃ  !!!
restartedMain: => Loda báº¥m chuÃ´ng vÃ  khai bÃ¡o há» tÃªn!
restartedMain: Loda quay lÆ°ng bá» Ä‘i
SimpleAsyncTaskExecutor-1: ChÃ³ ngá»§ dáº­y!!!
SimpleAsyncTaskExecutor-1: Go go!! CÃ³ ngÆ°á»i tÃªn lÃ  Loda gÃµ cá»­a!!!
```

Láº§n nÃ y quÃ¡ trÃ¬nh xá»­ lÃ½ Ä‘Ã£ diá»…n ra Ä‘Ãºng nhÆ° chÃºng ta mong Ä‘á»£i, ngÆ°á»i báº¥m cá»© báº¥m, mÃ  chÃ³ kÃªu cá»© kÃªu, má»—i ngÆ°á»i má»™t viá»‡c, cháº£ ai áº£nh hÆ°á»Ÿng tá»›i ai, chá»‰ cáº§n biáº¿t cÃ³ sá»± kiá»‡n xáº£y ra thÃ¬ pháº£n á»©ng lÃ  Ä‘Æ°á»£c.

### **Káº¿t**

ğŸ’Â Náº¿u cÃ³, toÃ n bá»™ project / code máº«u Ä‘Æ°á»£c lÆ°u trá»¯ táº¡i **GitHub**

ğŸŒŸÂ ÄÃ¢y lÃ  má»™t bÃ i viáº¿t trongÂ Series **LÃ m chá»§ Spring Boot â€“ Zero to Hero**

