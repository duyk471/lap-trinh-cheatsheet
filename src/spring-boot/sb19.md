# H∆∞·ªõng d·∫´n chi ti·∫øt Test Spring Boot (Ph·∫ßn 2)

Trong b√†i n√†y, t√¥i s·∫Ω t·∫≠p trung v√†o vi·ªác gi·ªõi thi·ªáu v·ªõi c√°c c√°c b·∫°n c√°ch chu·∫©n b·ªã d·ªØ li·ªáu test.

B√†i vi·∫øt c√≥ s·ª≠ d·ª•ng:

1. Hibernate l√† g√¨?
2. Spring JPA
3. Lombok
4. Spring Boot

### **C√†i ƒë·∫∑t**

```
<?xml version="1.0" encoding="UTF-8"?>
<projectxmlns="http://maven.apache.org/POM/4.0.0"xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"xsi:schemaLocation="http://maven.apache.org/POM/4.0.0https://maven.apache.org/xsd/maven-4.0.0.xsd"><modelVersion>4.0.0</modelVersion><parent><groupId>org.springframework.boot</groupId><artifactId>spring-boot-starter-parent</artifactId><version>2.0.5.RELEASE</version><relativePath/> <!-- lookup parent from repository -->
	</parent><groupId>me.loda.spring</groupId><artifactId>example-independent-maven-spring-project</artifactId><version>0.0.1-SNAPSHOT</version><name>example-independent-maven-spring-project</name><description>Demo project for Spring Boot</description><properties><java.version>1.8</java.version></properties><dependencies><dependency><groupId>org.springframework.boot</groupId><artifactId>spring-boot-starter-web</artifactId></dependency><dependency><groupId>org.springframework.boot</groupId><artifactId>spring-boot-devtools</artifactId><scope>runtime</scope><optional>true</optional></dependency><dependency><groupId>org.projectlombok</groupId><artifactId>lombok</artifactId><optional>true</optional></dependency><dependency><groupId>org.springframework.boot</groupId><artifactId>spring-boot-starter-test</artifactId><scope>test</scope></dependency><!--spring jpa-->
		<dependency><groupId>org.springframework.boot</groupId><artifactId>spring-boot-starter-data-jpa</artifactId></dependency><!--in memory database-->
		<dependency><groupId>com.h2database</groupId><artifactId>h2</artifactId><scope>runtime</scope></dependency></dependencies><build><plugins><plugin><groupId>org.springframework.boot</groupId><artifactId>spring-boot-maven-plugin</artifactId></plugin></plugins></build></project>
```

### **Prepare**

Tr∆∞·ªõc h·∫øt, gi·∫£ s·ª≠ ch√∫ng ta c√≥ m·ªôt h·ªá th·ªëng qu·∫£n l√Ω c√¥ng vi·ªác

_Todo.java_

```
@Data
@AllArgsConstructor
@NoArgsConstructor
@Entity
public class Todo {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;
    private String title;
    private String detail;
}
```

_TodoRepository.java_

```
public interface TodoRepository extends JpaRepository<Todo, Long> {
    List<Todo> findAll();

    Todo findById(int id);
}
```

_TodoController.java_

```
@RestController
@RequestMapping("/api/v1")
@RequiredArgsConstructor
public class TodoRestController {
    private final TodoService todoService;

    @GetMapping("/todo")
    public List<Todo> findAll() {
        return todoService.getAll();
    }
}
```

### **@DataJpaTest**

V·ªÅ c∆° b·∫£n, ch√∫ng ta kh√¥ng th·ªÉ mock hay l√†m gi·∫£ d·ªØ li·ªáu c·ªßa Database m√£i ƒë∆∞·ª£c, n√≥ s·∫Ω l√† m·ªôt l·ªó h·ªïng l·ªõn trong h·ªá th·ªëng. Ngo√†i ra, b·∫°n c≈©ng s·∫Ω kh√¥ng th·ªÉ test ƒë∆∞·ª£c qu√° tr√¨nh thao t√°c v·ªõi Database c·ªßa d·ª± √°n.

V·∫≠y n√™n sau c√πng, ch√∫ng ta c≈©ng s·∫Ω ph·∫£i test c√°c thao t√°c v·∫≠n h√†nh v·ªõi Database,

Nh∆∞ng ch·ªõ lo, ƒë·ªÉ t·∫≠p trung v√†o vi·ªác test c√°c thao t√°c v·ªõi Database, Spring Boot ƒë√£ h·ªó tr·ª£ ch√∫ng ta b·∫±ng¬†`@DataJpaTest`

K·∫øt h·ª£p gi·ªØa¬†`@DataJpaTest`¬†v√†¬†`h2-database`¬†(Memory database) l√† Combo ho√†n h·∫£o.

```
@RunWith(SpringRunner.class)
/**
 * Khi ƒë√°nh d·∫•u m·ªôt class l√† @DataJpaTest.
 * Spring Boot s·∫Ω load l√™n t·∫•t c·∫£ c√°c Bean c√≥ li√™n quan t·ªõi t·∫ßng Repository
 * Thay v√¨ load h·∫øt t·∫•t c·∫£ Bean nh∆∞ l√† @SpringBootTest
 */
@DataJpaTest
public class DataJpaAnnotationTest {

    @Autowired
    private DataSource dataSource;
    @Autowired
    private JdbcTemplate jdbcTemplate;
    @Autowired
    private EntityManager entityManager;
    @Autowired
    private TodoRepository todoRepository;

    @Test
    public void allComponentAreNotNull() {
        Assertions.assertThat(dataSource).isNotNull();
        Assertions.assertThat(jdbcTemplate).isNotNull();
        Assertions.assertThat(entityManager).isNotNull();
        Assertions.assertThat(todoRepository).isNotNull();
    }

}
```

`@DataJpaTest`¬†c√≥ t√°c d·ª•ng kh·ªüi t·∫°o c√°c Bean c·∫ßn thi·∫øt cho t·∫ßng Repository. Ngo√†i ra, n√≥ kh√¥ng kh·ªüi t·∫°o th√™m c√°c Bean th·ª´a th√£i n√†o kh√°c. (Chuy√™n bi·ªát h∆°n¬†`@SpringBootTest`)

### **T·∫°o Data**

C√°ch Fake d·ªØ li·ªáu ƒë∆°n gi·∫£n nh·∫•t l√† t·ª± insert b·∫±ng repository

```
import org.assertj.core.api.Assertions;
import org.junit.After;

    @Test
    public void testTodoRepositoryByCode() {
        todoRepository.save(new Todo(0, "Todo-1", "Detail-1"));
        todoRepository.save(new Todo(0, "Todo-2", "Detail-2"));

        Assertions.assertThat(todoRepository.findAll()).hasSize(2);
        Assertions.assertThat(todoRepository.findById(1).getTitle()).isEqualTo("Todo-1");
    }

    @After
    public void clean() {
        todoRepository.deleteAll();
    }
```

### **@Sql**

M·ªôt c√°ch l√†m hay h∆°n ƒë·ªÉ chu·∫©n b·ªã d·ªØ li·ªáu cho Test ƒë√≥ l√† s·ª≠ d·ª•ng annotation¬†`@Sql`

`@Sql`¬†c√≥ t√°c d·ª•ng load m·ªôt ho·∫∑c nhi·ªÅu file scripts sql l√™n v√† th·ª±c thi.

v√≠ d·ª•:

_createToDo.sql_

```
INSERT INTO todo (title, detail) VALUES ('Todo-1', 'Do homework');
INSERT INTO todo (title, detail) VALUES ('Todo-2', 'Walking');
```

ƒê·ªÉ ch·∫°y scripts n√†y trong class Test, b·∫°n l√†m nh∆∞ sau:

```
@RunWith(SpringRunner.class)
@DataJpaTest
public class SqlAnnotationTest {
    @Autowired
    private TodoRepository todoRepository;

    @Test
    @Sql("/createTodo.sql")
    public void testTodoRepositoryBySqlSchema() {
        Assertions.assertThat(todoRepository.findAll()).hasSize(2);
        Assertions.assertThat(todoRepository.findById(1).getTitle()).isEqualTo("Todo-1");
    }

}
```

ƒê·ªÉ ch·∫°y nhi·ªÅu file sql c√πng l√∫c, b·∫°n s·ª≠ d·ª•ng¬†`@SqlGroup`

### **K·∫øt**

üíÅ¬†N·∫øu c√≥, to√†n b·ªô project / code m·∫´u ƒë∆∞·ª£c l∆∞u tr·ªØ t·∫°i **GitHub**

üåü¬†ƒê√¢y l√† m·ªôt b√†i vi·∫øt trong¬†Series **L√†m ch·ªß Spring Boot ‚Äì Zero to Hero**

