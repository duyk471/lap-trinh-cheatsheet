# HÆ°á»›ng dáº«n chi tiáº¿t Test Spring Boot

HÃ´m nay chÃºng ta sáº½ tÃ¬m hiá»ƒu cÃ¡ch Ä‘á»ƒ viáº¿t TestCase trongÂ **Spring Boot**. YÃªu cáº§u tá»‘i thiáº¿u Ä‘á»ƒ Ä‘i tiáº¿p pháº§n nÃ y Ä‘Ã³ lÃ  báº¡n pháº£i cÃ³ ná»n táº£ng vá»›iÂ `JUnit`Â vÃ Â `Mockito`.

### **Váº¥n Ä‘á» Test + Spring**

**Spring Boot**Â sáº½ pháº£i táº¡o Context vÃ  tÃ¬m kiáº¿m cÃ¡c Bean vÃ  nhÃ©t vÃ o Ä‘Ã³. Sau táº¥t cáº£ cÃ¡c bÆ°á»›c config vÃ  khá»Ÿi táº¡o thÃ¬ chÃºng ta sá»­ dá»¥ngÂ `@Autowired`Â Ä‘á»ƒ láº¥y Ä‘á»‘i tÆ°á»£ng ra sá»­ dá»¥ng. Váº¥n Ä‘á» Ä‘áº§u tiÃªn báº¡n nghÄ© tá»›i khi viáº¿t Test sáº½ lÃ  lÃ m saoÂ `@Autowired`Â bean vÃ o class Test Ä‘Æ°á»£c vÃ  lÃ m sao choÂ `JUnit`Â hiá»ƒuÂ `@Autowired`Â lÃ  gÃ¬. HÆ°á»›ng giáº£i quyáº¿t lÃ  tÃ­ch há»£pÂ `Spring`Â vÃ o vá»›iÂ `JUnit`.

### **@RunWith(SpringRunner.class)**

**Spring Boot**Â Ä‘Ã£ thiáº¿t káº¿ ra lá»›pÂ `SpringRunner`, sáº½ giÃºp chÃºng ta tÃ­ch há»£pÂ **Spring + JUnit**.

Äá»ƒ test trong Spring, trong má»i class Test chÃºng ta sáº½ thÃªmÂ `@RunWith(SpringRunner.class)`Â lÃªn Ä‘áº§u Class Test Ä‘Ã³.

```
@RunWith(SpringRunner.class)
public class TodoServiceTest {
    ...
}
```

Khi báº¡n cháº¡yÂ `TodoServiceTest`Â nÃ³ sáº½ táº¡o ra má»™tÂ `Context`Â riÃªng Ä‘á»ƒ chá»©aÂ `bean`Â trong Ä‘Ã³, váº­y lÃ  chÃºng ta cÃ³ thá»ƒÂ `@Autowired`Â thoáº£i mÃ¡i trong ná»™i hÃ m Class nÃ y.

Váº¥n Ä‘á» tiáº¿p theo lÃ  lÃ m sao Ä‘Æ°aÂ `Bean`Â vÃ o trongÂ `Context`.

CÃ³ 2 cÃ¡ch

1. `@SpringBootTest`
2. `@TestConfiguration`

### **@SpringBootTest**

`@SpringBootTest`Â sáº½ Ä‘i tÃ¬m kiáº¿m class cÃ³ gáº¯nÂ `@SpringBootApplication`Â vÃ  tá»« Ä‘Ã³ Ä‘i tÃ¬m toÃ n bá»™Â `Bean`Â vÃ  náº¡p vÃ oÂ `Context`.

CÃ¡i nÃ y chá»‰ nÃªn sá»­ dá»¥ng trong trÆ°á»ng há»£p muá»‘n Integration Tests, vÃ¬ nÃ³ sáº½ táº¡o toÃ n bá»™Â `Bean`, khÃ´ng khÃ¡c gÃ¬ báº¡n cháº¡y cáº£ cÃ¡iÂ `SpringApplication.run(App.class, args);`, ráº¥t tá»‘n thá»i gian mÃ  ráº¥t nhiá»uÂ `Bean`Â thá»«a thÃ£i, khÃ´ng cáº§n dÃ¹ng Ä‘áº¿n cÅ©ng khá»Ÿi táº¡o.

```
@RunWith(SpringRunner.class)
@SpringBootTest
public class TodoServiceTest {

    /**
     * CÃ¡ch nÃ y sá»­ dá»¥ng @SpringBootTest
     * NÃ³ sáº½ load toÃ n bá»™ Bean trong app cá»§a báº¡n lÃªn,
     * Giá»‘ng vá»›i viá»‡c cháº¡y App.java váº­y
     */

    @Autowired
    private TodoService todoService;
}
```

### **@TestConfiguration**

`@TestConfiguration`Â giá»‘ng vá»›iÂ `@Configuration`, chÃºng ta tá»± Ä‘á»‹nh nghÄ©a raÂ `Bean`.

CÃ¡c Bean Ä‘Æ°á»£c táº¡o bá»ŸiÂ `@TestConfiguration`Â chá»‰ tá»“n táº¡i trong mÃ´i trÆ°á»ng Test. Ráº¥t phá»¥ há»£p vá»›i viá»‡c viáº¿t UnitTest.

Class Test nÃ o, cáº§n Bean gÃ¬, thÃ¬ tá»± táº¡o ra trongÂ `@TestConfiguration`

```
@RunWith(SpringRunner.class)
public class TodoServiceTest2 {

    /**
     * CÃ¡ch nÃ y sá»­ dá»¥ng @TestConfiguration
     * NÃ³ chá»‰ táº¡o ra Bean trong Context test nÃ y mÃ  thÃ´i
     * Tiáº¿t kiá»‡m thá»i gian hÆ¡n khi sá»­ dá»¥ng @SpringBootTest (vÃ¬ pháº£i load háº¿t Bean lÃªn mÃ  khÃ´ng dÃ¹ng Ä‘áº¿n)
     */
    @TestConfiguration
    public static class TodoServiceTest2Configuration{

        /*
        Táº¡o ra trong Context má»™t Bean TodoService
         */
        @Bean
        TodoService todoService(){
            return new TodoService();
        }
    }

    @Autowired
    private TodoService todoService;
```

### **@MockBean**

**Spring**Â há»— trá»£ mock vá»›i annotationÂ `@MockBean`, chÃºng ta cÃ³ thá»ƒ mock láº¥y ra má»™tÂ `Bean`Â "giáº£" mÃ  khÃ´ng thÃ¨m Ä‘á»ƒ Ã½ tá»›i tháº±ngÂ `Bean`Â "tháº­t". (Ká»ƒ cáº£ tháº±ng "tháº­t" cÃ³ á»Ÿ trong Context Ä‘i ná»¯a, cÅ©ng khÃ´ng quan tÃ¢m).

```
@RunWith(SpringRunner.class)
public class TodoServiceTest2 {

    /**
     * Äá»‘i tÆ°á»£ng TodoRepository sáº½ Ä‘Æ°á»£c mock, chá»© khÃ´ng pháº£i bean trong context
     */
    @MockBean
    TodoRepository todoRepository;
```

### **Demo 1**

ChÃºng ta sáº½ há»c cÃ¡ch sá»­ dá»¥ng cÃ¡c Annotation á»Ÿ trÃªn.

### **CÃ i Ä‘áº·t**

_pom.xml_

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <packaging>pom</packaging>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.0.5.RELEASE</version>
        <relativePath /> <!-- lookup parent from repository -->
    </parent>
    <groupId>me.loda.spring</groupId>
    <artifactId>spring-boot-learning</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>spring-boot-learning</name>
    <description>Everything about Spring Boot</description>

    <properties>
        <java.version>1.8</java.version>
    </properties>

    <dependencies>

        <!--spring mvc, rest-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!--for test-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
        <plugin>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-maven-plugin</artifactId>
        </plugin>
        </plugins>
    </build>

</project>
```

Cáº¥u trÃºc thÆ° má»¥c:

!image

### **Táº¡o Model, Service, Repository**

ChÃºng ta sá»­ dá»¥ngÂ LombokÂ cho tiá»‡n nhÃ©.

_Todo.java_

```
@Data
@AllArgsConstructor
public class Todo {
    private int id;
    private String title;
    private String detail;
}
```

VÃ¬ phá»¥c vá»¥ má»¥c Ä‘Ã­ch demo, chÃºng ta sáº½ khÃ´ng cáº§n sá»­ dá»¥ng tá»›iÂ **Spring JPA**Â mÃ  sáº½ tá»± viáº¿t.

_TodoRepository.java_

```
public interface TodoRepository {
    List<Todo> findAll();

    Todo findById(int id);
}
```

_TodoService.java_

```
@Service
public class TodoService {
    @Autowired
    private TodoRepository todoRepository;

    public int countTodo(){
        return todoRepository.findAll().size();
    }

    public Todo getTodo(int id){
        return todoRepository.findById(id);
    }

    public List<Todo> getAll(){
        return todoRepository.findAll();
    }
}
```

_App.java_

```
@SpringBootApplication
public class App {
    public static void main(String[] args) {
        SpringApplication.run(App.class, args);
    }
}
```

Ráº¥t Ä‘Æ¡n giáº£n.

### **Test báº±ng @SpringBootTest**

ChÃºng taÂ `mock TodoRepository`Â vÃ  giáº£ láº­p cho nÃ³ tráº£ ra má»™tÂ `List<Todo>`Â gá»“m 10 pháº§n tá»­.

```
@RunWith(SpringRunner.class)
@SpringBootTest
public class TodoServiceTest {

    /**
     * CÃ¡ch nÃ y sá»­ dá»¥ng @SpringBootTest
     * NÃ³ sáº½ load toÃ n bá»™ Bean trong app cá»§a báº¡n lÃªn,
     * Giá»‘ng vá»›i viá»‡c cháº¡y App.java váº­y
     */

    /**
     * Äá»‘i tÆ°á»£ng TodoRepository sáº½ Ä‘Æ°á»£c mock, chá»© khÃ´ng pháº£i bean trong context
     */
    @MockBean
    TodoRepository todoRepository;

    @Autowired
    private TodoService todoService;

    @Before
    public void setUp() {
        Mockito.when(todoRepository.findAll())
               .thenReturn(IntStream.range(0, 10)
                                    .mapToObj(i -> new Todo(i, "title-" + i, "detail-" + i))
                                    .collect(Collectors.toList()));

    }

    @Test
    public void testCount() {
        Assert.assertEquals(10, todoService.countTodo());
    }

}
```

Báº¡n sáº½ tháº¥y Test cháº¡y thÃ nh cÃ´ng, nhÆ°ng sáº½ máº¥t thá»i gian vÃ¬ khá»Ÿi táº¡oÂ `Context`Â quÃ¡ lÃ¢u doÂ `@SpringBootTest`Â pháº£i load háº¿t táº¥t cáº£ bean lÃªn.

### **Test báº±ng @TestConfiguration**

```
```java
package me.loda.spring.testinginspringboot;
/*******************************************************
 * For Vietnamese readers:
 *    CÃ¡c báº¡n thÃ¢n máº¿n, mÃ¬nh ráº¥t vui náº¿u project nÃ y giÃºp
 * Ã­ch Ä‘Æ°á»£c cho cÃ¡c báº¡n trong viá»‡c há»c táº­p vÃ  cÃ´ng viá»‡c. Náº¿u
 * báº¡n sá»­ dá»¥ng láº¡i toÃ n bá»™ hoáº·c má»™t pháº§n source code xin Ä‘á»ƒ
 * láº¡i dÆ°á»ng dáº«n tá»›i github hoáº·c tÃªn tÃ¡c giÃ¡.
 *    Xin cáº£m Æ¡n!
 *******************************************************/

import java.util.stream.Collectors;
import java.util.stream.IntStream;

import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mockito;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.context.annotation.Bean;
import org.springframework.test.context.junit4.SpringRunner;

@RunWith(SpringRunner.class)
public class TodoServiceTest2 {

    /**
     * CÃ¡ch nÃ y sá»­ dá»¥ng @TestConfiguration
     * NÃ³ chá»‰ táº¡o ra Bean trong Context test nÃ y mÃ  thÃ´i
     * Tiáº¿t kiá»‡m thá»i gian hÆ¡n khi sá»­ dá»¥ng @SpringBootTest (vÃ¬ pháº£i load háº¿t Bean lÃªn mÃ  khÃ´ng dÃ¹ng Ä‘áº¿n)
     */
    @TestConfiguration
    public static class TodoServiceTest2Configuration{

        /*
        Táº¡o ra trong Context má»™t Bean TodoService
         */
        @Bean
        TodoService todoService(){
            return new TodoService();
        }
    }

    @MockBean
    TodoRepository todoRepository;

    @Autowired
    private TodoService todoService;

    @Before
    public void setUp() {
        Mockito.when(todoRepository.findAll())
               .thenReturn(IntStream.range(0, 10)
                                    .mapToObj(i -> new Todo(i, "title-" + i, "detail-" + i))
                                    .collect(Collectors.toList()));

    }

    @Test
    public void testCount() {
        Assert.assertEquals(10, todoService.countTodo());
    }

}
```

### **Váº¥n Ä‘á» Test + Spring Boot 2**

á» trÃªn chÃºng ta Ä‘Ã£ xá»­ lÃ½ xong váº¥n Ä‘á» dependency injection cá»§aÂ **JUnit**Â +Â **Spring Boot**Â rá»“i.

Váº¥n Ä‘á» tiáº¿p theo lÃ  cÃ¡iÂ **Controller**. ÄÃºng váº­y, chÃºng ta táº¡o ra hÃ ng chá»¥c Rest API Ä‘Ã³n request ngÆ°á»i dÃ¹ng, váº­y lÃ m sao Ä‘á»ƒ test nÃ³.

Náº¿uÂ **Controller**Â khÃ´ng Ä‘Æ°á»£c test thÃ¬ lÃ  má»™t lá»— há»•ng cá»±c lá»›n, vÃ¬ nÃ³ lÃ  Ä‘áº§u ra chÃ­nh cá»§a chÆ°Æ¡ng trÃ¬nh, nÃ³ sai -> chÆ°Æ¡ng trÃ¬nh khÃ´ng cÃ³ giÃ¡ trá»‹.

Tuy nhiÃªn, chÃºng ta khÃ´ng muá»‘n khá»Ÿi Ä‘á»™ng cáº£ Tomcat Server + Database Ä‘á»ƒ test 1 API. NÃ³ ráº¥t tá»‘n tÃ i nguyÃªn vÃ  thá»i gian.

### **@WebMvcTest**

**Spring Boot**Â há»— trá»£ testÂ **Controller**Â mÃ  khÃ´ng cáº§n khá»Ÿi Ä‘á»™ng Tomcat Server báº±ng annotationÂ `@WebMvcTest`.

Táº¥t nhiÃªn lÃ  náº¿u khÃ´ng khá»Ÿi Ä‘á»™ng Server, thÃ¬ pháº£i cÃ³ má»™t phÆ°Æ¡ng thá»©c khÃ¡c giáº£ láº­p, vÃ¢ng, láº¡i lÃ Â **Mock**.

BÃ¢y giá», khi muá»‘n test má»™t Controller nÃ o Ä‘Ã³, chÃºng ta lÃ m nhÆ° sau:

```
@RunWith(SpringRunner.class)
// Báº¡n cáº§n cung cáº¥p lá»›p Controller cho @WebMvcTest
@WebMvcTest(TodoRestController.class)
public class TodoRestControllerTest {
    /**
     * Äá»‘i tÆ°á»£ng MockMvc do Spring cung cáº¥p
     * CÃ³ tÃ¡c dá»¥ng giáº£ láº­p request, thay tháº¿ viá»‡c khá»Ÿi Ä‘á»™ng Server
     */
    @Autowired
    private MockMvc mvc;
}
```

### **Demo 2**

ChÃºng ta váº«n sá»­ dá»¥ng tiáº¿p Project Ä‘Ã£ táº¡o á»ŸÂ **\# Demo 1**

### **Táº¡o Controller**

_TodoRestController.java_

```
@RestController
@RequestMapping("/api/v1")
public class TodoRestController {
    @Autowired
    TodoService todoService;

    @GetMapping("/todo")
    public List<Todo> findAll(){
        return todoService.getAll();
    }
}
```

### **Táº¡o Test Controller**

```
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.Matchers.hasSize;
import static org.mockito.BDDMockito.given;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.http.MediaType;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.test.web.servlet.MockMvc;

@RunWith(SpringRunner.class)
// Báº¡n cáº§n cung cáº¥p lá»›p Controller cho @WebMvcTest
@WebMvcTest(TodoRestController.class)
public class TodoRestControllerTest {
    /**
     * Äá»‘i tÆ°á»£ng MockMvc do Spring cung cáº¥p
     * CÃ³ tÃ¡c dá»¥ng giáº£ láº­p request, thay tháº¿ viá»‡c khá»Ÿi Ä‘á»™ng Server
     */
    @Autowired
    private MockMvc mvc;

    @MockBean
    private TodoService todoService;

    @Test
    public void testFindAll() throws Exception {
        // Táº¡o ra má»™t List<Todo> 10 pháº§n tá»­
        List<Todo> allTodos = IntStream.range(0, 10)
                                       .mapToObj(i -> new Todo(i, "title-" + i, "detail-" + i))
                                       .collect(Collectors.toList());

        // giáº£ láº­p todoService tráº£ vá» List mong muá»‘n
        given(todoService.getAll()).willReturn(allTodos);

        mvc.perform(get("/api/v1/todo").contentType(MediaType.APPLICATION_JSON)) // Thá»±c hiá»‡n GET REQUEST
           .andExpect(status().isOk()) // Mong muá»‘n Server tráº£ vá» status 200
           .andExpect(jsonPath("$", hasSize(10))) // Hi vá»ng server tráº£ vá» List Ä‘á»™ dÃ i 10
           .andExpect(jsonPath("$[0].id", is(0))) // Hi vá»ng pháº§n tá»­ tráº£ vá» Ä‘áº§u tiÃªn cÃ³ id = 0
           .andExpect(jsonPath("$[0].title", is("title-0"))) // Hi vá»ng pháº§n tá»­ tráº£ vá» Ä‘áº§u tiÃªn cÃ³ title = "title-0"
           .andExpect(jsonPath("$[0].detail", is("detail-0")));
    }
}
```

Cháº¡y thá»­ vÃ  tráº£i nghiá»‡m báº¡n nhÃ© :3

### **Káº¿t**

Test lÃ  má»™t pháº§n quan trá»ng trong há»‡ thá»‘ng, hi vá»ng cÃ¡c Ä‘á»c kÄ© vÃ  thá»±c hÃ nh Ä‘á»ƒ náº¯m cháº¯c.

ğŸ’Â Náº¿u cÃ³, toÃ n bá»™ project / code máº«u Ä‘Æ°á»£c lÆ°u trá»¯ táº¡i **GitHub**

ğŸŒŸÂ ÄÃ¢y lÃ  má»™t bÃ i viáº¿t trongÂ Series **LÃ m chá»§ Spring Boot â€“ Zero to Hero**

